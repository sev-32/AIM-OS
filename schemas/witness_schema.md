# SEG Witness Schema

**Last updated:** 2025-10-21  
**Source modules:** `packages/seg/witness.py`, `packages/apoe_runner/executor.py`, `packages/meta_optimizer/vision_tensor.py`

SEG witnesses are append-only JSONL records that provide auditable provenance for all boundary events (plan execution, tensor generation, policy enforcement, etc.). Every writer should emit payloads conforming to the schema below so downstream tooling (CMC replay, VIF dashboards, compliance exports) can process entries consistently.

---

## File Layout & Retention

- Default path: `packages/cmc_service/data/seg/witnesses.jsonl` (configurable via `write_witness(seg_dir=...)`).
- Format: **one UTF‑8 JSON object per line**, no trailing commas.
- Rotation/archival is handled by the caller; keep files immutable once published and move to cold storage according to retention policy (recommended: 90 days hot, 1 year warm, infinite cold).

---

## Required Fields

| Field | Type | Description |
| --- | --- | --- |
| `witness_id` | `str` | Stable identifier (`seg:witness:{uuid4}` if omitted). |
| `recorded_at` | `str` | ISO‑8601 UTC timestamp generated by `write_witness`. |
| `source` | `str` | Subsystem emitting the record (e.g. `"apoe_runner"`, `"vision_tensor"`). |
| `event` | `str` | Short verb phrase describing the action (`"plan.executed"`, `"tensor.generated"`). |
| `correlation_id` | `str` | Correlates to orchestration run / request / snapshot. |
| `status` | `str` | One of `success`, `failure`, `degraded`, `skipped`. |
| `payload` | `dict` | Event-specific evidence (see examples). |

All other fields are optional but strongly encouraged:

| Field | Type | Purpose |
| --- | --- | --- |
| `agents` | `list[str]` | Agents involved in the event. |
| `policies_applied` | `list[str]` | Policy pack IDs evaluated for this event. |
| `latency_ms` | `float` | Execution latency for performance dashboards. |
| `cost_usd` | `float` | Approximate cost impact for budgeting. |
| `uncertainty` | `float` | 0‑1 confidence score or DVNS-derived metric. |
| `evidence_links` | `list[str]` | URIs to supporting artifacts (snapshots, atoms, docs). |
| `notes` | `str` | Free-form human annotation. |

Unknown keys SHOULD be avoided; if new fields are required, document them here before emitting in production.

---

## Examples

### 1. APOE plan execution

```json
{
  "witness_id": "seg:witness:8c6d9dfa-1b13-4e59-a6a7-4c27bb3c6cb5",
  "recorded_at": "2025-10-21T11:42:03.812345Z",
  "source": "apoe_runner",
  "event": "plan.executed",
  "correlation_id": "orchestration:research-note:20251021",
  "status": "success",
  "latency_ms": 1842.3,
  "policies_applied": ["policy.default", "policy.safety.v1"],
  "agents": ["planner", "retriever", "builder"],
  "payload": {
    "plan_path": "plans/research_note.acl",
    "outputs": ["artifacts/research_note.md"],
    "witness_files": ["packages/cmc_service/data/seg/witnesses.jsonl"]
  }
}
```

### 2. Vision tensor generation

```json
{
  "witness_id": "seg:witness:1cfe4dd3-04f1-4f03-a27f-82a27a35f2b4",
  "recorded_at": "2025-10-21T09:15:12.104287Z",
  "source": "vision_tensor",
  "event": "tensor.generated",
  "correlation_id": "tensor:lucid-empire",
  "status": "success",
  "uncertainty": 0.18,
  "payload": {
    "tensor_axes": ["impact", "confidence", "risk"],
    "score": 0.87,
    "policy_pack_ids": ["policy.mige.default"],
    "summary": "Lucid Empire v0.2 blueprint synthesis"
  }
}
```

---

## Writing Witnesses

Use the shared helper to ensure IDs and timestamps are populated uniformly:

```python
from packages.seg.witness import write_witness

write_witness(
    {
        "source": "apoe_runner",
        "event": "plan.executed",
        "correlation_id": run_id,
        "status": "success",
        "payload": {...},
    }
)
```

If you need to store witnesses outside the default directory, pass `seg_dir=` or `filename=` overrides, but keep the JSONL format unchanged so downstream harvesters can parse files automatically.
